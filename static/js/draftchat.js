for(var chat=new CuttleChat,status_collect=document.getElementById("status_collect"),ranks_collect=document.getElementsByClassName("ranks_collect"),text_draft=document.getElementById("text_draft"),last_char,is_add_active=!1,start_index,collecting_word="",timeout_write,array_users=[],array_words=[],i=0;i<ranks_collect.length;i++)ranks_collect[i].addEventListener("click",addWord,!1);text_draft.addEventListener("keypress",updateStatus,!1);text_draft.addEventListener("keydown",checkBackspace,!1);
text_draft.addEventListener("paste",checkPaste,!1);function caretAtEnd(){var b=document.createRange(),c=window.getSelection();b.selectNodeContents(text_draft);b.collapse(!1);c.removeAllRanges();c.addRange(b)}
function getCaretPosition(){if(window.getSelection&&window.getSelection().getRangeAt){for(var b=window.getSelection().getRangeAt(0),c=window.getSelection(),a=0,d=c.anchorNode.parentNode.childNodes,e=0;e<d.length&&d[e]!=c.anchorNode;e++)d[e].outerHTML?a+=d[e].outerHTML.length:3==d[e].nodeType&&(a+=d[e].textContent.length);return b.startOffset+a}return-1}
function checkBackspace(b){var c=getCaretPosition();8===b.keyCode&&(is_add_active?""===collecting_word?is_add_active=!1:c===start_index+collecting_word.length?(collecting_word=collecting_word.slice(0,-1),status_collect.innerHTML="Requesting:&ensp;"+collecting_word+"&ensp;;<span class=\"status_explanation\">(click 'space' to start)</span>"):b.preventDefault():c<=start_index+collecting_word.length&&""!==collecting_word&&b.preventDefault());13===b.keyCode&&(is_add_active&&c===start_index+collecting_word.length&&
(is_add_active=!1,startCollecting()),document.execCommand("insertHTML",!1,"<br><br>"),b.preventDefault())}function checkPaste(b){(is_add_active||getCaretPosition()<=start_index+collecting_word.length-1&&""!==collecting_word)&&b.preventDefault()}
function updateStatus(b){clearTimeout(timeout_write);var c=getCaretPosition(),a=String.fromCharCode(b.which),d="";d="Writing...&ensp;<span class=\"status_explanation\">(type '?' + 'type of word' to ask chat for a word)</span>";is_add_active?c===start_index+collecting_word.length?" "===a?(is_add_active=!1,startCollecting()):collecting_word+=a:b.preventDefault():c<=start_index+collecting_word.length-1&&""!==collecting_word&&b.preventDefault();""===collecting_word?("?"===a&&(d="Requesting:"),"?"===last_char&&
" "!==a&&"?"!==a?(collecting_word+=a,is_add_active=!0,start_index=getCaretPosition(),d="Requesting:&ensp;"+collecting_word+"&ensp;<span class=\"status_explanation\">(click 'space' to start)</span>"):timeout_write=setTimeout(function(){status_collect.innerHTML="Waiting..."},2E3)):d=is_add_active?"Requesting:&ensp;"+collecting_word+" <span class=\"status_explanation\">(click 'space' to start)</span>":"Requesting: "+collecting_word+'&ensp;<span class="status_explanation">(Waiting for chat choices)</span>';
" "!==a||is_add_active||(document.execCommand("insertHTML",!1,"&ensp;"),b.preventDefault());status_collect.innerHTML=d;last_char=a}function indexOfMessage(b,c){for(var a=0;a<c.length;a++)if(c[a][0]===b)return a;return-1}
function startCollecting(){""!==collecting_word&&chat.open(function(b,c){if(-1===array_users.indexOf(b)){array_users.push(b);var a=indexOfMessage(c,array_words);-1<a?array_words[a][1]+=1:array_words.push([c,1,b]);array_words.sort(function(a,b){return a[1]===b[1]?0:a[1]>b[1]?-1:1});for(a=0;3>a;a++)if(array_words[a]){ranks_collect[a].style.display="inline-block";ranks_collect[a].dataset.word=array_words[a][0];ranks_collect[a].dataset.user=array_words[a][2];var d=" vote";1<array_words[a][1]&&(d=" votes");
ranks_collect[a].innerHTML=array_words[a][0]+": "+array_words[a][1]+d}}})}function addWord(b){chat.close();var c=text_draft.innerHTML;new_text=c.substr(0,start_index-1)+'<span class="added_word" contenteditable="false" data-user="'+b.target.dataset.user+': ">'+b.target.dataset.word+"</span>"+c.substr(start_index+collecting_word.length);text_draft.innerHTML=new_text;collecting_word="";array_users=[];array_words=[];for(b=0;3>b;b++)ranks_collect[b].style.display="none";caretAtEnd()}window.onload=function(){text_draft.focus()};
